<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <title>Контроль СИЗ (каска/жилет)</title>

    <!-- TensorFlow.js и библиотека Teachable Machine -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@latest/dist/teachablemachine-image.min.js"></script>

    <style>
        body {
            font-family: sans-serif;
            text-align: center;
            margin: 0;
            padding: 20px;
            background: #f5f5f5;
        }

        h1 {
            margin-bottom: 10px;
        }

        button {
            padding: 10px 20px;
            font-size: 16px;
            margin-top: 10px;
            cursor: pointer;
        }

        #webcam-container {
            margin-top: 20px;
            display: flex;
            justify-content: center;
        }

        #webcam-container canvas {
            border: 2px solid #999;
            background: #000;
        }

        #label-container {
            margin-top: 15px;
        }

        #label-container div {
            margin: 4px 0;
            font-size: 16px;
        }

        /* КРУГЛЫЙ ИНДИКАТОР СТАТУСА */
        #status-indicator {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            margin: 20px auto 0 auto;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 16px;
            box-shadow: 0 0 20px rgba(0,0,0,0.25);
            text-align: center;
            padding: 10px;
        }

        /* СИЗ надеты (зелёный) */
        #status-indicator.ok {
            background-color: #2ecc71;
            box-shadow: 0 0 25px rgba(46, 204, 113, 0.8);
        }

        /* СИЗ нет (красный) */
        #status-indicator.bad {
            background-color: #e74c3c;
            box-shadow: 0 0 25px rgba(231, 76, 60, 0.8);
        }
    </style>
</head>
<body>
    <h1>Прототип контроля ношения СИЗ</h1>
    <p>Камера + нейросеть определяют, надеты ли каска и жилет.</p>

    <button onclick="init()">Запустить камеру и модель</button>

    <!-- КРУГ-ИНДИКАТОР СТАТУСА -->
    <div id="status-indicator" class="bad">ОЖИДАНИЕ<br>КАМЕРЫ/МОДЕЛИ</div>

    <!-- КАМЕРА -->
    <div id="webcam-container"></div>

    <!-- ВЕРОЯТНОСТИ КЛАССОВ -->
    <div id="label-container"></div>

    <script>
        // ====== НАСТРОЙКИ ПОД ТЕБЯ ======

        // 1. ПУТЬ К ФАЙЛАМ МОДЕЛИ
        // Если model.json и metadata.json лежат РЯДОМ с index.html:
        const MODEL_DIR = ""; // пустая строка

        // Если они лежат в папке "model", то так:
        // const MODEL_DIR = "model/";

        const modelURL = MODEL_DIR + "model.json";
        const metadataURL = MODEL_DIR + "metadata.json";

        // 2. ТОЧНЫЕ ИМЕНА КЛАССОВ ИЗ Teachable Machine
        // Узнай их в metadata.json -> "labels": ["...", "..."]
        // ПРИМЕР: если там ["WITH_PPE","NO_PPE"], то оставляй так:
        const CLASS_WITH_PPE = "WITH_PPE"; // класс: СИЗ надеты
        const CLASS_NO_PPE   = "NO_PPE";   // класс: СИЗ нет

        // Если у тебя, например, ["СИЗ_ЕСТЬ","СИЗ_НЕТ"], то надо так:
        // const CLASS_WITH_PPE = "СИЗ_ЕСТЬ";
        // const CLASS_NO_PPE   = "СИЗ_НЕТ";

        // ====== ДАЛЬШЕ МОЖНО НЕ МЕНЯТЬ ======

        let model, webcam, labelContainer, maxPredictions;

        async function init() {
            // Загружаем модель
            model = await tmImage.load(modelURL, metadataURL);
            maxPredictions = model.getTotalClasses();
            console.log("Model loaded, classes:", maxPredictions);

            // Настраиваем веб-камеру
            const flip = true;
            webcam = new tmImage.Webcam(400, 300, flip);

            try {
                await webcam.setup(); // запрос доступа к камере
                await webcam.play();
            } catch (e) {
                console.error("Ошибка доступа к камере:", e);
                alert("Браузер не получил доступ к камере. Разреши использование камеры в настройках сайта.");
                return;
            }

            window.requestAnimationFrame(loop);

            // Добавляем камеру на страницу
            const webcamContainer = document.getElementById("webcam-container");
            webcamContainer.innerHTML = "";
            webcamContainer.appendChild(webcam.canvas);

            // Контейнер для вероятностей
            labelContainer = document.getElementById("label-container");
            labelContainer.innerHTML = "";
            for (let i = 0; i < maxPredictions; i++) {
                labelContainer.appendChild(document.createElement("div"));
            }

            // Обновим индикатор
            const indicator = document.getElementById("status-indicator");
            indicator.textContent = "Идёт анализ...";
        }

        async function loop() {
            webcam.update();
            await predict();
            window.requestAnimationFrame(loop);
        }

        async function predict() {
            const prediction = await model.predict(webcam.canvas);

            // Отладка: вывод в консоль, какие есть классы и вероятности
            // Открой F12 -> Console и посмотри:
            console.log(prediction.map(p => `${p.className}: ${p.probability.toFixed(2)}`));

            // Пишем вероятности внизу
            for (let i = 0; i < maxPredictions; i++) {
                const classPrediction =
                    prediction[i].className + ": " +
                    prediction[i].probability.toFixed(2);
                labelContainer.childNodes[i].innerHTML = classPrediction;
            }

            // Находим самый вероятный класс
            let bestIndex = 0;
            let bestProb = prediction[0].probability;
            for (let i = 1; i < maxPredictions; i++) {
                if (prediction[i].probability > bestProb) {
                    bestProb = prediction[i].probability;
                    bestIndex = i;
                }
            }
            const bestClassName = prediction[bestIndex].className;

            // Обновляем кружок-индикатор
            const indicator = document.getElementById("status-indicator");

            if (bestClassName === CLASS_WITH_PPE) {
                indicator.classList.remove("bad");
                indicator.classList.add("ok");
                indicator.textContent = "СИЗ НАДЕТЫ";
            } else if (bestClassName === CLASS_NO_PPE) {
                indicator.classList.remove("ok");
                indicator.classList.add("bad");
                indicator.textContent = "НЕТ СИЗ";
            } else {
                // На случай, если есть другие классы
                indicator.classList.remove("ok");
                indicator.classList.add("bad");
                indicator.textContent = bestClassName;
            }
        }
    </script>
</body>
</html>